apiVersion: v1
kind: ConfigMap
metadata:
  name: ingress-nginx-404-redirect
  namespace: flux-system
  labels:
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/component: controller
data:
  redirect-404.lua: |
    -- Custom Lua plugin to redirect 404 responses to google.com
    local ngx = ngx
    
    -- Hook into the rewrite_by_lua phase
    -- This will intercept requests and check if they would result in 404
    -- Intercept in the access_by_lua phase to check for 404 responses
    function redirect_404()
        -- Check if this is a 404 response
        if ngx.status == 404 then
            ngx.redirect("https://www.google.com", 302)
            return
        end
    end
    
    -- Hook into the body_filter_by_lua phase to intercept 404 responses
    function body_filter_404()
        -- This runs after the response is generated
        if ngx.status == 404 then
            ngx.status = 302
            ngx.header["Location"] = "https://www.google.com"
            ngx.header.content_length = nil
            return
        end
    end

